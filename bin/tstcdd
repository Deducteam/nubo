#!/bin/sh

# Return the Topologically Sorted Transitive Closure of the Dedukti
# Dependencies of the file given as argument. It exits with 1 if no file is
# given as argument, and 0 otherwise.
# tstcdd foo.dk == bar baz blah foo

has_dep () {
    # A "quicker" way to see if a file has dependencies (rather than computing
    # them all)
    grep -qE '\w+\.\w+' "$1"
}

tsort_deps_aux () {
   deps="$(dkdeps $1)" 
   for d in $deps; do
       printf '%s %s\n' "$(basename $1 '.dk')" "$d"
       tsort_deps_aux "${d}.dk"
   done
}

if [ -z "$1" ]; then
    exit 1
fi
if has_dep "$1"; then
    tsort_deps_aux "$1" | tsort - | tr '\n' ' ' | xargs reverse
else
    # Simply print the name of the module if it has no dependency
    printf '%s' "$(basename $1 '.dk')" | xargs
fi
